{"url":"undefined","class":"database","cargs":"[\"mutall_diaspora\"]","method":"get_sql_data","margs":"[\"with\\n    # Redefine a beneficiary to extend it with a name\\n    beneficiary as (\\n        select \\n            user.name,\\n            #\\n            # The event for supporting join to the beneficiary\\n            event.event\\n        from \\n            beneficiary\\n            inner join event on beneficiary.event = event.event\\n            inner join membership on beneficiary.membership = membership.membership\\n            inner join user on membership.user = user.user\\n    ),\\n    #\\n    #Define a contributor and her contribution\\n    contributor as (\\n        select \\n            user.name,\\n            event.name as event_name, \\n            contribution.amount,\\n            beneficiary.name as beneficiary,\\n            #\\n            #The event for supporting the join to the beneficiary\\n            event.event,\\n            #\\n            #Add a membership to support a left join later\\n            membership.membership\\n        from \\n            contribution\\n            inner join event on contribution.event = event.event\\n            inner join contributor on contribution.contributor = contributor.contributor\\n            inner join membership on contributor.membership = membership.membership\\n            inner join user on membership.user = user.user\\n            #\\n            #Use a left join, just incase the beneficiary data is missing\\n            left join beneficiary on beneficiary.event = event.event\\n    ),\\n\\n    # Join contributors and beneficiaries using the contribution event\\n    contributions as (\\n        select\\n            user.name,\\n            membership.start_date,\\n            membership.num,\\n            json_object(\\n                'event', event_name, \\n                'amount', contributor.amount,\\n                'beneficiary', contributor.beneficiary\\n            ) as contribution    \\n        from\\n            membership\\n            left join contributor on contributor.membership = membership.membership\\n            inner join user on membership.user = user.user\\n    ),\\n    \\n    # Do the left margin summaries\\n    left_summary as (\\n        select\\n            name,\\n            num,\\n            json_arrayagg(contribution) as contribution,\\n            sum(contribution->>'$.amount') as total,\\n            count(contribution->>'$.amount') as count\\n        from\\n            contributions\\n        group by name, num\\n    ),\\n\\n    # Count all the mmebers in the group\\n    membership as (\\n        select\\n            count(membership) as count\\n        from\\n            membership\\n            inner join chama on membership.chama = chama.chama\\n        where\\n            chama.name='diasp'\\n    ),\\n    \\n    # Do the bottom margin summaries\\n    bottom_summary_calc as (\\n        select\\n            contribution->>'$.event' as event,\\n            sum(contribution->>'$.amount') as total,\\n            count(contribution->>'$.amount') as members,\\n            membership.count as out_of\\n        from\\n            contributions\\n            join membership\\n        group by contribution->>'$.event', membership.count\\n    ),\\n    #\\n    #Report on the bottom margin calulations\\n    bottom_summary as (\\n        select\\n            event,\\n            json_array(\\n                total, \\n                members, \\n                out_of, concat(format(members\/out_of*100,0),'%')\\n            ) as summaries\\n        from\\n            bottom_summary_calc\\n    ),\\n    #\\n    # Do the gross total\\n    gross as (\\n        select\\n            sum(contribution->>'$.amount') as amount\\n        from\\n            contributions\\n    )\\n table gross\"]"}